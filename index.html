<html>
<head>
    <meta charset="utf-8"/>
    <style type="text/css">
        body {
            text-align: center;
        }

        body > div {
            width: 800px;
            margin: auto;
            text-align: left;
        }

        form.file_selection table {
            width: 100%;
        }

        form.file_selection td {
            width: 50%;
            padding: 0 20px;
            vertical-align: top;
        }

        form.file_selection select {
            width: 100%;
        }

        form.file_selection ul.syntax_highlight select {
            width: auto;
            display: inline-block;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
</head>
<body>
<h2 style="text-align: center;">Подготовка документа "Текст программы" для курсача</h2>

<div id="error_unsupported" style="display: none;">
    <em style="color: red">Нихуя не получится, так как у вас установлен говеный браузер, в котором не поддерживается
        File API</em>
</div>

<div id="step1">
    <p>1. Загрузить свой проект в виде zip-архива: <input type="file" id="file"/>
    <p><em>Внимание: обработка файлов происходит на клиенте</em>
    <p id="error_unzip" style="display: none;"><em style="color: red;">Не удалось распаковать zip-архив. Это вообще
        архив?</em>

    <div id="result"></div>
</div>

<script type="text/javascript">
    if (!window.FileReader || !window.ArrayBuffer) {
        $("#step1").hide();
        $("#error_unsupported").show();
    }
</script>

<div id="step2" style="display: none;">
    <hr/>

    <p>2. Выбрать файлы для включения в документ:

    <p><form class="file_selection">
        <table>
            <tr>
                <td>
                    <p>Выбрать по расширениям:
                    <p><select id="extension_list" size="8" multiple>
                        <!-- Populated programmatically -->
                    </select>
                </td>
                <td rowspan="2">
                    <p><select id="file_list" size="20" multiple>
                        <!-- Populated programmatically -->
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <p>Подсветка синтаксиса:
                    <p><ul class="syntax_highlight">
                        <li>.cs: <select>
                            <option>C#</option>
                        </select>
                        <li>.xaml: <select>
                            <option>XML</option>
                        </select>
                    </ul>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center; padding: 20px 0;">
                    <input id="pognali" type="button" value="Слабать хуйню"/>
                </td>
            </tr>
        </table>
    </form>
</div>

<div id="error_none_selected" style="display: none;">
    <em style="color: red">Не выбрано ни одного файла</em>
</div>

<div id="step3" style="display: none; width: 100%;">
    <div style="width: 800px; margin: auto;">
        <hr/>

        <p>3. Скопировать размеченный текст и вставить его в <a href="#">шаблон документа</a>.
    </div>
    <div id="layed_out_code">

    </div>
</div>

<script type="text/javascript">
    (function() {
        var $file_list_select = $("select#file_list");
        var $extension_list_select = $("select#extension_list");

        $("#file").on("change", function(evt) {
            $file_list_select.html("");
            $extension_list_select.html("");

            $("div#step2").hide();
            $("div#error_unzip").hide();

            $("div#step3").hide();
            $("div#error_none_selected").hide();

            JSZip.loadAsync(evt.target.files[0])
                .then(function(zip) {
                    var $file_extensions = {};

                    zip.forEach(function(relativePath, zipEntry) {
                        if(!zipEntry.dir) {
                            $file_name = zipEntry.name;
                            $file_extension = $file_name.split(".").pop().toLowerCase();

                            $file_list_select.append($("<option>", {
                                value: $file_name,
                                text: $file_name
                            }));

                            $file_extensions[$file_extension] = true;
                        }
                    });

                    for(var $extension in $file_extensions) {
                        $extension_list_select.append($("<option>", {
                            value: $extension,
                            text: "." + $extension
                        }));
                    }

                    $("div#step2").slideDown();
                }, function(e) {
                    $("#error_unzip").show();
                });
        });

        $extension_list_select.on("click", "option", function(evt) {
            var $extension = evt.target.value;

            $("select#file_list option").each(function() {
                var $current_extension = $(this).attr("value").split(".").pop().toLowerCase();

                if($current_extension === $extension) {
                    $(this).attr("selected", evt.target.selected);
                }
            });

            console.log($extension);
        });

        $("input#pognali").on("click", function(evt){
            $("div#step3").hide();

            $("div#error_none_selected").hide();

            var $selected_options = $file_list_select.children("option:selected");

            if($selected_options.length > 0) {
                var $results_div = $("div#layed_out_code");

                $results_div.html("");

                $selected_options.each(function() {
                    $results_div.append($("<p>", {
                        text: $(this).attr("value")
                    }));
                });

                $("div#step3").slideDown();
            }
            else {
                $("div#error_none_selected").show();
            }
        });
    })();
</script>
</body>
</html>