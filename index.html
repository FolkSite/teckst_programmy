<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Подготовка документа "Текст программы" для курсача</title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">
    <style type="text/css">
        body {
            text-align: center;
        }

        body > div {
            width: 800px;
            margin: auto;
            text-align: left;
        }

        form.file_selection table {
            width: 100%;
        }

        form.file_selection td {
            width: 50%;
            padding: 0 20px;
            vertical-align: top;
        }

        form.file_selection select {
            width: 100%;
        }

        form.file_selection select#file_list {
            min-height: 300px;
            height: 100%;
        }

        .height100 {
            height: 100%;
        }

        form.file_selection .syntax_highlighting_settings select {
            width: auto;
            display: inline-block;
        }

        div#layout pre {
            font-family: "Courier New", Courier, monospace;
            font-size: 10pt;
        }

        .hljs {
            background: white;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
</head>
<body>
<h2 style="text-align: center;">Подготовка документа "Текст программы" для курсача</h2>

<div id="error_unsupported" style="display: none;">
    <em style="color: red">Нихуя не получится, так как у вас установлен говеный браузер, в котором не поддерживается
        File API</em>
</div>

<div id="step1">
    <p>1. Загрузить свой проект в виде zip-архива: <input type="file" id="file"/>
    <p><em>Внимание: обработка файлов происходит на клиенте</em>
    <p id="error_unzip" style="display: none;"><em style="color: red;">Не удалось распаковать zip-архив. Это вообще
        архив?</em>

    <div id="result"></div>
</div>

<script type="text/javascript">
    if (!window.FileReader || !window.ArrayBuffer) {
        $("#step1").hide();
        $("#error_unsupported").show();
    }
</script>

<div id="step2" style="display: none;">
    <hr/>

    <p>2. Выбрать файлы для включения в документ:

    <p><form class="file_selection">
        <table>
            <tr>
                <td>
                    <p>Выбрать по расширениям:
                    <p><select id="extension_list" size="8" multiple>
                        <!-- Populated programmatically -->
                    </select>
                </td>
                <td class="height100" rowspan="2">
                    <p class="height100"><select id="file_list" multiple>
                        <!-- Populated programmatically -->
                    </select>
                </td>
            </tr>
            <tr>
                <td class="height100">
                    <p>Подсветка синтаксиса:
                    <p><ul class="syntax_highlighting_settings">
                        <!-- Populated programmatically -->
                    </ul>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center; padding: 40px 0 20px;">
                    <input id="pognali" type="button" value="Слабать хуйню"/>
                </td>
            </tr>
        </table>
    </form>
</div>

<div id="error_none_selected" style="display: none;">
    <em style="color: red">Не выбрано ни одного файла</em>
</div>

<div id="step3" style="display: none; width: 100%;">
    <div style="width: 800px; margin: auto;">
        <hr/>

        <p>3. Скопировать размеченный текст и вставить его в <a href="#">шаблон документа</a>.
    </div>
    <div id="layout">
        <!-- Populated programmatically -->
    </div>
</div>

<script type="text/javascript">
    var $syntax_classes = [
        ["(никакая)", ""],
        ["C#", "csharp"],
        ["XML", "xml"],
        ["Java", "java"]
    ];

    var getSyntaxClassByExtension = function(extension) {

    };

    (function() {
        var $zip_archive;

        var $file_list_select = $("select#file_list");
        var $extension_list_select = $("select#extension_list");

        $("#file").on("change", function(evt) {
            $zip_archive = evt.target.files[0];

            $file_list_select.html("");
            $extension_list_select.html("");

            $("div#step2").hide();
            $("div#error_unzip").hide();

            $("div#step3").hide();
            $("div#error_none_selected").hide();

            JSZip.loadAsync(evt.target.files[0])
                .then(function(zip) {
                    var $file_extensions = {};

                    zip.forEach(function(relativePath, zipEntry) {
                        if(!zipEntry.dir) {
                            $file_name = zipEntry.name;
                            $file_extension = $file_name.split(".").pop().toLowerCase();

                            $file_list_select.append($("<option>", {
                                value: $file_name,
                                text: $file_name
                            }));

                            $file_extensions[$file_extension] = true;
                        }
                    });

                    var $syntax_highlighting_settings = $(".syntax_highlighting_settings");
                    $syntax_highlighting_settings.html("");

                    for(var $extension in $file_extensions) {
                        $extension_list_select.append($("<option>", {
                            value: $extension,
                            text: "." + $extension
                        }));

                        $syntax_highlighting_settings.append($("<li>", {
                            text: "." + $extension + ": ",
                            class: "syntax_classes"
                        }).hide().append($("<select>", {
                            id: $extension
                        })));
                    }

                    var $syntax_classes_selects = $(".syntax_classes select");

                    $syntax_classes_selects.html("");

                    $syntax_classes.forEach(function($syntax_class) {
                        console.log($syntax_classes_selects);

                        $syntax_classes_selects.append($("<option>", {
                            value: $syntax_class[1],
                            text: $syntax_class[0]
                        }));
                    });

                    $("div#step2").slideDown();
                }, function(e) {
                    $("#error_unzip").show();
                });
        });

        /*
         * TODO: Change selection only for files of the extensions of which "selected" the property was changed
         * TODO: (see e967ed8 commit message)
         */
        $extension_list_select.on("change", function(evt) {
            var $extensions = $(evt.target).val();

            $("select#file_list option").each(function() {
                var $current_extension = $(this).attr("value").split(".").pop().toLowerCase();

                /*
                 * TODO: Fix the problem when a change of the selected property of an option is no not visually
                 * TODO: represented in Chrome if the user has clicked on the option before
                 */
                if($extensions.indexOf($current_extension) >= 0) {
                    $(this).attr("selected", true);
                }
                else {
                    $(this).removeAttr("selected");
                }
            });

            $file_list_select.change();
        });

        $file_list_select.on("change", function(evt) {
            var $file_extensions = {};

            $file_list_select.val().forEach(function($filename) {
                $file_extensions[$filename.split(".").pop()] = true;
            });

            var $syntax_classes_selects = $(".syntax_classes");

            $syntax_classes_selects.hide();

            $syntax_classes_selects.each(function() {
                if($file_extensions[$(this).children("select").attr("id")]) {
                    $(this).show();
                }
            });
        });

        $("input#pognali").on("click", function(evt){
            $("div#step3").hide();

            $("div#error_none_selected").hide();

            var $selected_options = $file_list_select.children("option:selected");

            if($selected_options.length > 0) {
                var $results_div = $("div#layout");

                $results_div.html("");

                var $selected_files = {};

                $selected_options.each(function() {
                    $selected_files[$(this).attr("value")] = true;
                });

                JSZip.loadAsync($zip_archive)
                    .then(function(zip) {
                        zip.forEach(function(relativePath, zipEntry) {
                            if($selected_files[zipEntry.name]) {
                                var $extension = zipEntry.name.split(".").pop();

                                zipEntry.async("string").then(
                                    function(content) {
                                        $results_div.append($("<h2>", {
                                            text: zipEntry.name
                                        }));

                                        $results_div.append($("<pre>", {
                                            text: content,
                                            class: $(".syntax_classes select#" + $extension).val()
                                        }));
                                    },
                                    function() { }
                                );
                            }
                        });
                    }, function() { });

                /*
                 * TODO: figure out how to do this properly
                 */
                setTimeout(function() {
                    $('pre').each(function(i, block) {
                        hljs.highlightBlock(block);
                    });
                }, 1000);

                $("div#step3").slideDown();
            }
            else {
                $("div#error_none_selected").show();
            }
        });
    })();
</script>
</body>
</html>